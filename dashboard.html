<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EcoPackAI â€“ Module 7 BI Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
       .top-buttons {
  position: fixed;
  top: 15px;
  right: 20px;              /* Change to left:20px if needed */
  display: flex;
  gap: 12px;
  z-index: 1000;
}

.custom-btn {
  padding: 10px 20px;
  font-weight: 600;
  border-radius: 25px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.custom-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
}
    body { background:#f8f9fa; }
    .card { margin-bottom:20px; }
    .metric-box {
      background:white;
      padding:15px;
      border-radius:8px;
      border:1px solid #dee2e6;
      text-align:center;
    }
    .metric-box h4 { color:#198754; }
  </style>
</head>

<body>
<div class="container mt-4">

  <h2 class="text-center mb-4">ðŸŒ± EcoPackAI â€“ Business Intelligence Dashboard</h2>
  <a href="index.html">
    <button class="btn btn-secondary custom-btn">
      â¬… Back to Main App
    </button>
  </a>
  <br><br>
  <!-- METRICS -->
  <div class="row">
    <div class="col-md-4">
      <div class="metric-box">
        <p>Average COâ‚‚ Reduction</p>
        <h4 id="co2Reduction">0%</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="metric-box">
        <p>Average Cost Savings</p>
        <h4 id="costSavings">0%</h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="metric-box">
        <p>Total Materials</p>
        <h4 id="materialCount">0</h4>
      </div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="card mt-4">
    <div class="card-header bg-primary text-white">COâ‚‚ Reduction (%)</div>
    <div class="card-body"><div id="co2Chart"></div></div>
  </div>

  <div class="card">
    <div class="card-header bg-success text-white">Cost Savings (%)</div>
    <div class="card-body"><div id="costChart"></div></div>
  </div>

  <div class="card">
    <div class="card-header bg-warning">Material Usage Trends</div>
    <div class="card-body"><div id="usageChart"></div></div>
  </div>

  <!-- EXPORT -->
  <div class="text-center mb-5">
    <button class="btn btn-danger me-2" onclick="exportPDF()">Export PDF</button>
    <button class="btn btn-success" onclick="exportExcel()">Export Excel</button>
  </div>

</div>

<script>
const API_URL = "http://127.0.0.1:5000/api/module7/bi-data";
let materials = [];

async function loadData() {
  const res = await fetch(API_URL);
  const json = await res.json();

  materials = json.data;

  materials.forEach(m => {
    m.co2Reduction = ((m.baseline_co2 - m.predicted_co2) / m.baseline_co2) * 100;
    m.costSavings = ((m.baseline_cost - m.predicted_cost) / m.baseline_cost) * 100;
  });

  document.getElementById("co2Reduction").innerText =
    avg(materials.map(m => m.co2Reduction)) + "%";

  document.getElementById("costSavings").innerText =
    avg(materials.map(m => m.costSavings)) + "%";

  document.getElementById("materialCount").innerText = materials.length;

  Plotly.newPlot("co2Chart", [{
    x: materials.map(m => m.name),
    y: materials.map(m => m.co2Reduction),
    type: "bar"
  }]);

  Plotly.newPlot("costChart", [{
    x: materials.map(m => m.name),
    y: materials.map(m => m.costSavings),
    type: "bar"
  }]);

  Plotly.newPlot("usageChart", [{
    labels: materials.map(m => m.name),
    values: materials.map(() => 1),
    type: "pie"
  }]);
}

function avg(arr) {
  return (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1);
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  pdf.setFont("helvetica", "normal");
  pdf.setFontSize(16);
  pdf.text("EcoPackAI Sustainability Report", 20, 20);

  pdf.setFontSize(11);
  let y = 40;

  materials.forEach(m => {
    pdf.text(
      `Material: ${m.name}`, 20, y
    ); y += 7;

    pdf.text(
      `CO2 Reduction: ${m.co2Reduction.toFixed(2)} %`, 20, y
    ); y += 7;

    pdf.text(
      `Cost Savings: ${m.costSavings.toFixed(2)} %`, 20, y
    ); y += 10;
  });

  pdf.save("EcoPackAI_Report.pdf");
}

function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(materials.map(m => ({
    Material: m.name,
    "COâ‚‚ Reduction %": m.co2Reduction.toFixed(2),
    "Cost Savings %": m.costSavings.toFixed(2)
  })));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "BI Metrics");
  XLSX.writeFile(wb, "EcoPackAI_Report.xlsx");
}

loadData();
</script>

</body>
</html>
